package com.example.demo.service;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

import org.springframework.ai.chat.client.ChatClient;
import org.springframework.stereotype.Service;

import com.example.demo.dto.BudgetPlannerResponseDTO;
import com.example.demo.dto.CategoryBreakdownDTO;
import com.example.demo.dto.ExpenseResponseDTO;
import com.example.demo.dto.FinancialNarrativeResponseDTO;
import com.example.demo.dto.RecommendedAllocationDTO;
import com.example.demo.dto.RiskDetectionResponseDTO;
import com.example.demo.entity.User;
import com.example.demo.exception.ResourceNotFoundException;

import tools.jackson.databind.JsonNode;
import tools.jackson.databind.ObjectMapper;

@Service
public class AIService {

    private final ExpenseService expenseService;
    private final ChatClient chatClient;
    private final ObjectMapper objectMapper;
    private final UserService userService;

   
        public AIService(ExpenseService expenseService,ChatClient.Builder builder, ObjectMapper objectMapper,UserService userService) {
        this.chatClient = builder.build();
        this.expenseService = expenseService;
        this.objectMapper = objectMapper;
        this.userService=userService;
    }

        public FinancialNarrativeResponseDTO generateFinancialNarrative(
                Long userId, int year, int month) {

            // 1Ô∏è‚É£ Fetch expenses for given month & year
            List<ExpenseResponseDTO> expenses =
                    expenseService.getExpensesByMonth(userId, year, month);

            if (expenses == null || expenses.isEmpty()) {
                throw new ResourceNotFoundException(
                        "No expenses found for user " + userId +
                                " for month " + month + " and year " + year
                );
            }

            // 2Ô∏è‚É£ Calculate total spending (month specific)
            BigDecimal totalSpending = expenses.stream()
                    .map(ExpenseResponseDTO::getAmt)
                    .reduce(BigDecimal.ZERO, BigDecimal::add);

            // 3Ô∏è‚É£ Group by category
            Map<String, BigDecimal> categoryTotals =
                    expenses.stream()
                            .collect(Collectors.groupingBy(
                                    exp -> exp.getCategory().getName(),
                                    Collectors.reducing(
                                            BigDecimal.ZERO,
                                            ExpenseResponseDTO::getAmt,
                                            BigDecimal::add
                                    )
                            ));

            // 4Ô∏è‚É£ Determine highest & lowest spending categories
            Map.Entry<String, BigDecimal> highest =
                    categoryTotals.entrySet()
                            .stream()
                            .max(Map.Entry.comparingByValue())
                            .orElseThrow();

            Map.Entry<String, BigDecimal> lowest =
                    categoryTotals.entrySet()
                            .stream()
                            .min(Map.Entry.comparingByValue())
                            .orElseThrow();

            // 5Ô∏è‚É£ Convert category map into breakdown DTO list
            List<CategoryBreakdownDTO> breakdownList =
                    categoryTotals.entrySet()
                            .stream()
                            .map(entry -> new CategoryBreakdownDTO(
                                    entry.getKey(),
                                    entry.getValue()
                            ))
                            .toList();

            try {

                // 6Ô∏è‚É£ Prepare AI prompt (Narrative only)
            	String userPrompt = """
                        All monetary values are in Indian Rupees (INR).
                        Use ‚Çπ symbol if mentioning currency.
                        Do NOT use dollar ($) symbol.

                        Total Spending (INR): ‚Çπ%s
                        Category Breakdown (INR): %s
                        Highest Spending Category: %s (‚Çπ%s)
                        Lowest Spending Category: %s (‚Çπ%s)

                        Generate a concise 3-4 line financial analysis summary.
                        Base insights strictly on numeric values provided.
                        Do not add introductory phrases.
                        Return plain text only.
                        """
                        .formatted(
                                totalSpending,
                                categoryTotals,
                                highest.getKey(),
                                highest.getValue(),
                                lowest.getKey(),
                                lowest.getValue()
                        );

                // 7Ô∏è‚É£ Call AI to generate narrative only
                String narrative = chatClient.prompt()
                        .system("You are a financial assistant providing spending insights.")
                        .user(userPrompt)
                        .call()
                        .content();

                // 8Ô∏è‚É£ Construct final response manually (deterministic structure)
                FinancialNarrativeResponseDTO response =
                        new FinancialNarrativeResponseDTO();

                response.setTotalSpending(totalSpending);
                response.setHighestSpendingCategory(highest.getKey());
                response.setLowestSpendingCategory(lowest.getKey());
                response.setCategoryBreakdown(breakdownList);
                response.setNarrative(narrative);

                return response;

            } catch (Exception e) {
                throw new RuntimeException(
                        "Failed to generate financial narrative from AI", e
                );
            }
        }
        
        
        public RiskDetectionResponseDTO categoryWiseRiskDetection(
                Long userId, int year, int month) {

            // 1Ô∏è‚É£ Fetch monthly expenses
            List<ExpenseResponseDTO> expenses =
                    expenseService.getExpensesByMonth(userId, year, month);

            if (expenses == null || expenses.isEmpty()) {
                throw new ResourceNotFoundException(
                        "No expenses found for user " + userId +
                                " for month " + month + " and year " + year);
            }

            // 2Ô∏è‚É£ Get total spending using ready-made method
            BigDecimal totalSpending =
                    expenseService.getMonthlySummary(userId);

            if (totalSpending == null ||
                    totalSpending.compareTo(BigDecimal.ZERO) == 0) {
                throw new IllegalStateException(
                        "Monthly total spending is zero or invalid.");
            }

            // 3Ô∏è‚É£ Aggregate category totals
            Map<String, BigDecimal> categoryTotals = new HashMap<>();

            for (ExpenseResponseDTO expense : expenses) {

                if (expense.getCategory() == null) continue;

                String category =expense.getCategory().getName().toUpperCase();

                categoryTotals.merge(
                        category,
                        expense.getAmt(),
                        BigDecimal::add
                );
            }

            List<String> riskyCategories = new ArrayList<>();
            List<String> safeCategories = new ArrayList<>();

            // 4Ô∏è‚É£ Risk classification logic (deterministic)
            for (Map.Entry<String, BigDecimal> entry : categoryTotals.entrySet()) {

                BigDecimal percentage = entry.getValue()
                        .divide(totalSpending, 4, RoundingMode.HALF_UP)
                        .multiply(BigDecimal.valueOf(100));

                // HIGH risk if > 40%
                if (percentage.compareTo(BigDecimal.valueOf(40)) > 0) {
                    riskyCategories.add(entry.getKey());
                } else {
                    safeCategories.add(entry.getKey());
                }
            }

            // 5Ô∏è‚É£ AI Consolidated Narrative
            String prompt = """
            		You are given structured financial data.

            		Total Monthly Spending: ‚Çπ%s
            		Category-wise Spending: %s
            		Risky Categories (>40%% of total): %s
            		Safe Categories: %s

            		Generate a concise financial risk summary in 4‚Äì5 lines.

            		Rules:
            		- Use only the data provided.
            		- Do NOT assume external factors.
            		- Do NOT mention Indian households.
            		- Do NOT exaggerate.
            		- Do NOT use markdown or bullet points.
            		- Keep tone professional and analytical.
            		- Return plain text only.
            		"""
            		.formatted(
            		        totalSpending,
            		        categoryTotals,
            		        riskyCategories,
            		        safeCategories
            		);

            String narrative = chatClient.prompt()
                    .system("You are a financial risk analysis assistant specializing in Indian spending patterns.")
                    .user(prompt)
                    .call()
                    .content();

            // 6Ô∏è‚É£ Build Response
            RiskDetectionResponseDTO response =
                    new RiskDetectionResponseDTO();

            response.setRiskyCategories(riskyCategories);
            response.setSafeCategories(safeCategories);
            response.setRiskAnalysisNarrative(narrative);

            return response;
        }
        
        
        public BudgetPlannerResponseDTO smartBudgetPlanner(
                Long userId, int year, int month) {

            // 1Ô∏è‚É£ Fetch User
            User user = userService.getUserById(userId);

            if (user == null) {
                throw new ResourceNotFoundException(
                        "User not found with id " + userId);
            }

            BigDecimal salary = user.getMonthlyIncome();

            if (salary == null || salary.compareTo(BigDecimal.ZERO) <= 0) {
                throw new IllegalStateException(
                        "User monthly income is invalid.");
            }

            // 2Ô∏è‚É£ Fetch Monthly Expenses
            List<ExpenseResponseDTO> expenses =
                    expenseService.getExpensesByMonth(userId, year, month);

            if (expenses == null || expenses.isEmpty()) {
                throw new ResourceNotFoundException(
                        "No expenses found for user " + userId +
                                " for month " + month + " and year " + year);
            }

            // 3Ô∏è‚É£ Aggregate Category Totals (Deterministic)
            Map<String, BigDecimal> categoryTotals = new HashMap<>();

            for (ExpenseResponseDTO expense : expenses) {

                if (expense.getCategory() == null) continue;

                String category =
                        expense.getCategory().getName().toUpperCase();

                categoryTotals.merge(
                        category,
                        expense.getAmt(),
                        BigDecimal::add
                );
            }

            // 4Ô∏è‚É£ Get Total Spending (Existing Method)
            BigDecimal totalSpending =
                    expenseService.getMonthlySummary(userId);

            if (totalSpending == null) {
                totalSpending = BigDecimal.ZERO;
            }

            // 5Ô∏è‚É£ Calculate Remaining Amount
            BigDecimal remainingAmount = salary.subtract(totalSpending);

            if (remainingAmount.compareTo(BigDecimal.ZERO) < 0) {
                remainingAmount = BigDecimal.ZERO;
            }

         // 6Ô∏è‚É£ Smart Allocation Logic

            BigDecimal minimumSavings =
                    salary.multiply(BigDecimal.valueOf(0.20));

            BigDecimal availableForSpending =
                    salary.subtract(minimumSavings);

            BigDecimal maxCategoryLimit =
                    salary.multiply(BigDecimal.valueOf(0.35));

            List<RecommendedAllocationDTO> allocations =
                    new ArrayList<>();

            BigDecimal totalCurrentSpending = BigDecimal.ZERO;

            for (BigDecimal value : categoryTotals.values()) {
                totalCurrentSpending = totalCurrentSpending.add(value);
            }

            for (Map.Entry<String, BigDecimal> entry : categoryTotals.entrySet()) {

                BigDecimal proportionalAmount =
                        entry.getValue()
                                .divide(totalCurrentSpending, 4, RoundingMode.HALF_UP)
                                .multiply(availableForSpending);

                // üö´ Cap category at 35% of salary
                if (proportionalAmount.compareTo(maxCategoryLimit) > 0) {
                    proportionalAmount = maxCategoryLimit;
                }

                BigDecimal percentage =
                        proportionalAmount
                                .divide(salary, 4, RoundingMode.HALF_UP)
                                .multiply(BigDecimal.valueOf(100));

                RecommendedAllocationDTO dto =
                        new RecommendedAllocationDTO();

                dto.setCategoryName(entry.getKey());
                dto.setRecommendedAmount(
                        proportionalAmount.setScale(2, RoundingMode.HALF_UP)
                );
                dto.setRecommendedPercentage(
                        percentage.setScale(2, RoundingMode.HALF_UP)
                );

                allocations.add(dto);
            }
            // 7Ô∏è‚É£ AI Narrative Only (NO JSON, NO STRUCTURE)
            String prompt = """
                    You are given structured financial data.

                    Monthly Salary: ‚Çπ%s
                    Total Spending: ‚Çπ%s
                    Remaining Amount: ‚Çπ%s
                    Minimum Recommended Savings (20%%): ‚Çπ%s
                    Category Allocations: %s

                    Generate a professional financial planning narrative
                    in 4‚Äì6 lines.

                    Rules:
                    - Do NOT generate new numbers.
                    - Do NOT suggest JSON.
                    - Do NOT use markdown.
                    - Keep tone analytical and practical.
                    - Return plain text only.
                    """
                    .formatted(
                            salary,
                            totalSpending,
                            remainingAmount,
                            minimumSavings,
                            allocations
                    );

            String narrative = chatClient.prompt()
                    .system("You are a financial planning assistant specializing in structured analysis.")
                    .user(prompt)
                    .call()
                    .content();

            // 8Ô∏è‚É£ Build Final Response
            BudgetPlannerResponseDTO response =
                    new BudgetPlannerResponseDTO();

            response.setPlanningNarrative(narrative);
            response.setRecommendedCategoryAllocations(allocations);

            return response;
        }
}