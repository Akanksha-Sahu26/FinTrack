package com.example.demo.service;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

import org.springframework.ai.chat.client.ChatClient;
import org.springframework.stereotype.Service;

import com.example.demo.dto.BudgetPlannerResponseDTO;
import com.example.demo.dto.CategoryBreakdownDTO;
import com.example.demo.dto.ExpenseResponseDTO;
import com.example.demo.dto.FinancialNarrativeResponseDTO;
import com.example.demo.dto.RecommendedAllocationDTO;
import com.example.demo.dto.RiskDetectionResponseDTO;
import com.example.demo.entity.User;
import com.example.demo.exception.ResourceNotFoundException;

import tools.jackson.databind.JsonNode;
import tools.jackson.databind.ObjectMapper;

@Service
public class AIService {

    private final ExpenseService expenseService;
    private final ChatClient chatClient;
    private final ObjectMapper objectMapper;
    private final UserService userService;

   
        public AIService(ExpenseService expenseService,ChatClient.Builder builder, ObjectMapper objectMapper,UserService userService) {
        this.chatClient = builder.build();
        this.expenseService = expenseService;
        this.objectMapper = objectMapper;
        this.userService=userService;
    }

        public FinancialNarrativeResponseDTO generateFinancialNarrative(
                Long userId, int year, int month) {

            // 1️⃣ Fetch expenses for given month & year
            List<ExpenseResponseDTO> expenses =
                    expenseService.getExpensesByMonth(userId, year, month);

            if (expenses == null || expenses.isEmpty()) {
                throw new ResourceNotFoundException(
                        "No expenses found for user " + userId +
                                " for month " + month + " and year " + year
                );
            }

            // 2️⃣ Calculate total spending (month specific)
            BigDecimal totalSpending = expenses.stream()
                    .map(ExpenseResponseDTO::getAmt)
                    .reduce(BigDecimal.ZERO, BigDecimal::add);

            // 3️⃣ Group by category
            Map<String, BigDecimal> categoryTotals =
                    expenses.stream()
                            .collect(Collectors.groupingBy(
                                    exp -> exp.getCategory().getName(),
                                    Collectors.reducing(
                                            BigDecimal.ZERO,
                                            ExpenseResponseDTO::getAmt,
                                            BigDecimal::add
                                    )
                            ));

            // 4️⃣ Determine highest & lowest spending categories
            Map.Entry<String, BigDecimal> highest =
                    categoryTotals.entrySet()
                            .stream()
                            .max(Map.Entry.comparingByValue())
                            .orElseThrow();

            Map.Entry<String, BigDecimal> lowest =
                    categoryTotals.entrySet()
                            .stream()
                            .min(Map.Entry.comparingByValue())
                            .orElseThrow();

            // 5️⃣ Convert category map into breakdown DTO list
            List<CategoryBreakdownDTO> breakdownList =
                    categoryTotals.entrySet()
                            .stream()
                            .map(entry -> new CategoryBreakdownDTO(
                                    entry.getKey(),
                                    entry.getValue()
                            ))
                            .toList();

            try {

                // 6️⃣ Prepare AI prompt (Narrative only)
            	String userPrompt = """
                        All monetary values are in Indian Rupees (INR).
                        Use ₹ symbol if mentioning currency.
                        Do NOT use dollar ($) symbol.

                        Total Spending (INR): ₹%s
                        Category Breakdown (INR): %s
                        Highest Spending Category: %s (₹%s)
                        Lowest Spending Category: %s (₹%s)

                        Generate a concise 3-4 line financial analysis summary.
                        Base insights strictly on numeric values provided.
                        Do not add introductory phrases.
                        Return plain text only.
                        """
                        .formatted(
                                totalSpending,
                                categoryTotals,
                                highest.getKey(),
                                highest.getValue(),
                                lowest.getKey(),
                                lowest.getValue()
                        );

                // 7️⃣ Call AI to generate narrative only
                String narrative = chatClient.prompt()
                        .system("You are a financial assistant providing spending insights.")
                        .user(userPrompt)
                        .call()
                        .content();

                // 8️⃣ Construct final response manually (deterministic structure)
                FinancialNarrativeResponseDTO response =
                        new FinancialNarrativeResponseDTO();

                response.setTotalSpending(totalSpending);
                response.setHighestSpendingCategory(highest.getKey());
                response.setLowestSpendingCategory(lowest.getKey());
                response.setCategoryBreakdown(breakdownList);
                response.setNarrative(narrative);

                return response;

            } catch (Exception e) {
                throw new RuntimeException(
                        "Failed to generate financial narrative from AI", e
                );
            }
        }
        
        
        public RiskDetectionResponseDTO categoryWiseRiskDetection(
                Long userId, int year, int month) {

            
           
            String prompt = """
            		You are given structured financial data.

            		Total Monthly Spending: ₹%s
            		Category-wise Spending: %s
            		Risky Categories (>40%% of total): %s
            		Safe Categories: %s

            		Generate a concise financial risk summary in 4–5 lines.

            		Rules:
            		- Use only the data provided.
            		- Do NOT assume external factors.
            		- Do NOT mention Indian households.
            		- Do NOT exaggerate.
            		- Do NOT use markdown or bullet points.
            		- Keep tone professional and analytical.
            		- Return plain text only.
            		"""
            		.formatted(
            		        totalSpending,
            		        categoryTotals,
            		        riskyCategories,
            		        safeCategories
            		);

            String narrative = chatClient.prompt()
                    .system("You are a financial risk analysis assistant specializing in Indian spending patterns.")
                    .user(prompt)
                    .call()
                    .content();

            // 6️⃣ Build Response
            RiskDetectionResponseDTO response =
                    new RiskDetectionResponseDTO();

            response.setRiskyCategories(riskyCategories);
            response.setSafeCategories(safeCategories);
            response.setRiskAnalysisNarrative(narrative);

            return response;
        }
        
        
        public BudgetPlannerResponseDTO smartBudgetPlanner(Long userId, int year, int month) {

            // 1️⃣ Fetch user
            User user = userService.getUserById(userId);
            if (user == null) {
                throw new ResourceNotFoundException("User not found with id " + userId);
            }

            BigDecimal salary = user.getMonthlyIncome();
            if (salary == null || salary.compareTo(BigDecimal.ZERO) <= 0) {
                throw new IllegalStateException("User monthly income is invalid.");
            }

            // 2️⃣ Fetch monthly expenses
            List<ExpenseResponseDTO> expenses = expenseService.getExpensesByMonth(userId, year, month);
            if (expenses == null || expenses.isEmpty()) {
                throw new ResourceNotFoundException(
                        "No expenses found for user " + userId + " for month " + month + " and year " + year);
            }

            // 3️⃣ Aggregate category totals
            Map<String, BigDecimal> categoryTotals = new HashMap<>();
            for (ExpenseResponseDTO expense : expenses) {
                if (expense.getCategory() == null) continue;
                String category = expense.getCategory().getName().toUpperCase();
                categoryTotals.merge(category, expense.getAmt(), BigDecimal::add);
            }

            // 4️⃣ Get total spending
            BigDecimal totalSpending = expenseService.getMonthlySummary(userId);
            if (totalSpending == null) totalSpending = BigDecimal.ZERO;

            // 5️⃣ Set minimum savings (20% of salary)
            BigDecimal minimumSavings = salary.multiply(BigDecimal.valueOf(0.20));
            BigDecimal availableBudget = salary.subtract(minimumSavings);

            if (availableBudget.compareTo(BigDecimal.ZERO) < 0) availableBudget = BigDecimal.ZERO;

            // 6️⃣ Smart allocation logic with caps and redistribution
            BigDecimal maxCategoryLimit = salary.multiply(BigDecimal.valueOf(0.35)); // No category > 35%
            List<RecommendedAllocationDTO> allocations = new ArrayList<>();

            // 6a. Calculate initial proportional allocations
            BigDecimal totalCurrentSpending = categoryTotals.values().stream()
                    .reduce(BigDecimal.ZERO, BigDecimal::add);

            Map<String, BigDecimal> tempAllocations = new HashMap<>();
            for (Map.Entry<String, BigDecimal> entry : categoryTotals.entrySet()) {
                BigDecimal proportionalAmount = (totalCurrentSpending.compareTo(BigDecimal.ZERO) > 0) ?
                        entry.getValue().divide(totalCurrentSpending, 4, RoundingMode.HALF_UP)
                                .multiply(availableBudget)
                        : BigDecimal.ZERO;
                tempAllocations.put(entry.getKey(), proportionalAmount);
            }

            // 6b. Cap categories and track excess
            BigDecimal excess = BigDecimal.ZERO;
            for (Map.Entry<String, BigDecimal> entry : tempAllocations.entrySet()) {
                if (entry.getValue().compareTo(maxCategoryLimit) > 0) {
                    excess = excess.add(entry.getValue().subtract(maxCategoryLimit));
                    tempAllocations.put(entry.getKey(), maxCategoryLimit);
                }
            }

            // 6c. Redistribute excess to uncapped categories proportionally
            BigDecimal uncappedTotal = tempAllocations.values().stream()
                    .filter(v -> v.compareTo(maxCategoryLimit) < 0)
                    .reduce(BigDecimal.ZERO, BigDecimal::add);

            if (uncappedTotal.compareTo(BigDecimal.ZERO) > 0 && excess.compareTo(BigDecimal.ZERO) > 0) {
                for (Map.Entry<String, BigDecimal> entry : tempAllocations.entrySet()) {
                    if (entry.getValue().compareTo(maxCategoryLimit) < 0) {
                        BigDecimal share = entry.getValue().divide(uncappedTotal, 4, RoundingMode.HALF_UP)
                                .multiply(excess);
                        entry.setValue(entry.getValue().add(share));
                    }
                }
            }

            // 6d. Build final RecommendedAllocationDTO list
            for (Map.Entry<String, BigDecimal> entry : tempAllocations.entrySet()) {
                RecommendedAllocationDTO dto = new RecommendedAllocationDTO();
                dto.setCategoryName(entry.getKey());
                dto.setRecommendedAmount(entry.getValue().setScale(2, RoundingMode.HALF_UP));
                dto.setRecommendedPercentage(entry.getValue().divide(salary, 4, RoundingMode.HALF_UP)
                        .multiply(BigDecimal.valueOf(100)).setScale(2, RoundingMode.HALF_UP));
                allocations.add(dto);
            }

            // 7️⃣ AI Narrative Only
            String prompt = """
                    You are a financial planning assistant.

                    User monthly income: ₹%s
                    Total spending for the month: ₹%s
                    Minimum recommended savings: ₹%s
                    Recommended allocations per category: %s

                    Generate a user-friendly financial planning narrative:
                    - Explain how the user should plan spending.
                    - Highlight categories that are overspending or underused.
                    - Give suggestions for maintaining healthy budget habits.
                    - Return plain text only, 5-7 sentences max.
                    """
                    .formatted(salary, totalSpending, minimumSavings, allocations);

            String narrative = chatClient.prompt()
                    .system("You are a financial planning assistant specializing in structured insights.")
                    .user(prompt)
                    .call()
                    .content();

            // 8️⃣ Build final response
            BudgetPlannerResponseDTO response = new BudgetPlannerResponseDTO();
            response.setPlanningNarrative(narrative);
            response.setRecommendedCategoryAllocations(allocations);

            return response;
        }
}